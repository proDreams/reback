# Napkin Tools: ReBack (Restore Backup Utility)

![GitHub License](https://img.shields.io/github/license/proDreams/reback)
![GitHub Actions Workflow Status](https://img.shields.io/github/actions/workflow/status/proDreams/reback/build-release.yml)
![GitHub Release](https://img.shields.io/github/v/release/proDreams/reback)
![GitHub Downloads](https://img.shields.io/github/downloads/proDreams/reback/total)

Эта утилита предназначена для пользователей серверов, которым необходимо регулярно создавать бэкапы баз данных (
PostgreSQL, MongoDB и MySQL) и директорий. ReBack поддерживает сохранение бэкапов как локально, так и в S3-совместимых
хранилищах, организуя их в удобной структуре и автоматически отслеживая срок хранения.

В будущих версиях будет добавлен функционал восстановления бэкапов, включая полное восстановление или восстановление
конкретных элементов.

## Оглавление

- [Возможности](#возможности)
- [Требования](#требования)
- [Установка](#установка)
    - [Вариант 1: Скачать из релизов](#вариант-1-скачать-из-релизов)
    - [Вариант 2: Сборка локально](#вариант-2-сборка-локально)
- [Конфигурация](#конфигурация)
    - [Параметры конфигурации](#параметры-конфигурации)
    - [Добавление элементов для бэкапа](#добавление-элементов-для-бэкапа)
    - [Доступные типы элементов](#доступные-типы-элементов)
    - [Таблица параметров элементов бэкапа](#таблица-параметров-элементов-бэкапа)
    - [Общие параметры для всех элементов](#общие-параметры-для-всех-элементов)
- [Использование](#использование)
    - [Запуск как Cron задача](#запуск-как-cron-задача)
- [Автор](#автор)
- [Поддержка](#поддержка)
- [Лицензия](#лицензия)

## Возможности

- Поддержка бэкапа PostgreSQL, MongoDB и MySQL как установленных локально, так и в Docker-контейнерах.
- Бэкап локальных директорий.
- Сохранение бэкапов локально и в S3-совместимых хранилищах.
- Организация бэкапов в подкаталогах по именам элементов, указанным в конфигурации.
- Генерация имён файлов бэкапов на основе имени элемента и времени создания.
- Логирование всех шагов процесса.
- Конфигурирование через JSON-файл `settings.json`.

## Требования

- Установленный Docker (для бэкапа из контейнеров).
- S3-совместимое хранилище (для удалённого сохранения бэкапов).

## Установка

### Вариант 1: Скачать из релизов

Вы можете скачать последнюю версию с [страницы релизов](https://github.com/proDreams/reback/releases/latest).  
Поддерживаются следующие платформы:

- **macOS (Intel и ARM)**: `reback_macos_intel`, `reback_macos_aarch`
- **Linux**: `reback_linux`
- **Windows**: `reback.exe`

1. Перейдите на [страницу релизов](https://github.com/proDreams/reback/releases/latest).
2. Скачайте подходящий бинарник для вашей операционной системы.
3. **Для Linux и macOS**: Сделайте файл исполнимым, выполнив команду:

    ```bash
    chmod +x reback
    ```

### Вариант 2: Сборка локально

Если вы хотите собрать приложение самостоятельно, выполните следующие шаги:

**Требования:**

- Установленный Rust (рекомендуемая версия: `rustc 1.83.0`).
- Менеджер инструментов Rust: `rustup 1.27.1` или выше.

1. Клонируйте репозиторий:

    ```bash
    git clone https://github.com/proDreams/reback.git
    cd reback
    ```

2. Соберите приложение в режиме релиза:

    ```bash
    cargo build --release
    ```

3. Сделайте бинарник исполнимым (для Linux/macOS):

    ```bash
    chmod +x target/release/reback
    ```

## Конфигурация

Приложение конфигурируется через файл `settings.json`, который должен находиться в той же директории, что и исполняемый
файл (`reback`).

1. Создайте файл `settings.json` рядом с исполняемым файлом (`reback`).
2. Скопируйте следующий шаблон в ваш `settings.json` и измените значения под вашу среду:

```json
{
  "s3_endpoint": "https://s3.example.com",
  "s3_region": "us-east-1",
  "s3_bucket": "my-bucket",
  "s3_access": "access-key",
  "s3_secret": "secret-key",
  "s3_path_style": "path",
  "backup_dir": "/tmp/backups",
  "elements": []
}
```

### Параметры конфигурации:

- **s3_endpoint**: URL вашего S3-совместимого хранилища.
- **s3_region**: Регион вашего S3-хранилища.
- **s3_bucket**: Имя S3-бакета, куда будут сохраняться бэкапы.
- **s3_access**: Ключ доступа для подключения к S3.
- **s3_secret**: Секретный ключ для подключения к S3.
- **s3_path_style**: Указывает стиль пути для S3 (например, "path" или "virtual-host").
- **backup_dir**: Абсолютный путь до директории, где будут храниться локальные бэкапы. Если директория не существует,
  она будет создана автоматически.
- **elements**: Массив объектов, каждый из которых описывает элемент для бэкапа (например, базу данных или директорию).

### Добавление элементов для бэкапа:

Вы можете добавлять элементы для бэкапа в массив `elements` конфигурационного файла. Каждый элемент представляет собой
объект с параметрами для бэкапа определенного типа. Пример:

```json
{
  "elements": [
    {
      "element_title": "my_pg_db",
      "s3_folder": "postgres_backups",
      "backup_retention_days": 30,
      "s3_backup_retention_days": 90,
      "params": {
        "type": "postgresql",
        "db_host": "localhost",
        "db_port": 5432,
        "db_name": "my_database",
        "db_user": "user",
        "db_password": "password"
      }
    },
    {
      "element_title": "project_folder",
      "s3_folder": "folder_backups",
      "backup_retention_days": 30,
      "s3_backup_retention_days": 90,
      "params": {
        "type": "folder",
        "target_path": "/path/to/folder"
      }
    }
  ]
}
```

Полный пример конфигурации доступен в файле [settings.json.example](settings.json.example).

### Доступные типы элементов:

- `postgresql` — Бэкап базы данных PostgreSQL.
- `postgresql_docker` — Бэкап базы данных PostgreSQL из Docker-контейнера.
- `mongodb` — Бэкап базы данных MongoDB.
- `mongodb_docker` — Бэкап базы данных MongoDB из Docker-контейнера.
- `mysql` — Бэкап базы данных MySQL.
- `mysql_docker` — Бэкап базы данных MySQL из Docker-контейнера.
- `folder` — Бэкап локальной директории.

### Таблица параметров элементов бэкапа:

| Тип элемента          | Параметр           | Описание                                      | Обязательность |
|-----------------------|--------------------|-----------------------------------------------|----------------|
| **postgresql**        | `db_host`          | Хост базы данных. По умолчанию: `localhost`.  | Необязательный |
|                       | `db_port`          | Порт для подключения.                         | Обязательный   |
|                       | `db_name`          | Имя базы данных.                              | Обязательный   |
|                       | `db_user`          | Пользователь базы данных.                     | Обязательный   |
|                       | `db_password`      | Пароль пользователя.                          | Обязательный   |
|                       |                    |                                               |                |
| **postgresql_docker** | `docker_container` | Имя контейнера Docker с PostgreSQL.           | Обязательный   |
|                       | `db_name`          | Имя базы данных.                              | Обязательный   |
|                       | `db_user`          | Пользователь базы данных.                     | Обязательный   |
|                       | `db_password`      | Пароль пользователя.                          | Обязательный   |
|                       |                    |                                               |                |
| **mongodb**           | `db_host`          | Хост базы данных. По умолчанию: `localhost`.  | Необязательный |
|                       | `db_port`          | Порт для подключения.                         | Обязательный   |
|                       | `db_user`          | Пользователь базы данных.                     | Необязательный |
|                       | `db_password`      | Пароль пользователя.                          | Необязательный |
|                       |                    |                                               |                |
| **mongodb_docker**    | `docker_container` | Имя контейнера Docker с MongoDB.              | Обязательный   |
|                       | `db_user`          | Пользователь базы данных.                     | Необязательный |
|                       | `db_password`      | Пароль пользователя.                          | Необязательный |
|                       |                    |                                               |                |
| **mysql**             | `db_host`          | Хост базы данных. По умолчанию: `localhost`.  | Необязательный |
|                       | `db_port`          | Порт для подключения.                         | Обязательный   |
|                       | `db_name`          | Имя базы данных.                              | Обязательный   |
|                       | `db_user`          | Пользователь базы данных.                     | Обязательный   |
|                       | `db_password`      | Пароль пользователя.                          | Обязательный   |
|                       |                    |                                               |                |
| **mysql_docker**      | `docker_container` | Имя контейнера Docker с MySQL.                | Обязательный   |
|                       | `db_name`          | Имя базы данных.                              | Обязательный   |
|                       | `db_user`          | Пользователь базы данных.                     | Обязательный   |
|                       | `db_password`      | Пароль пользователя.                          | Обязательный   |
|                       |                    |                                               |                |
| **folder**            | `target_path`      | Путь до директории, которую нужно забэкапить. | Обязательный   |

### Общие параметры для всех элементов:

| Параметр                     | Описание                                                          |
|------------------------------|-------------------------------------------------------------------|
| **element_title**            | Название элемента (для использования в имени директории и файла). |
| **s3_folder**                | Папка в S3 для хранения бэкапов.                                  |
| **backup_retention_days**    | Количество дней хранения локальных бэкапов.                       |
| **s3_backup_retention_days** | Количество дней хранения бэкапов в S3.                            |

## Использование

Для запуска процесса бэкапа выполните следующую команду:

```bash
./reback backup
```

**Важно**: Аргумент `backup` обязателен для запуска процесса бэкапа. Без него программа не будет выполняться, и вы
получите ошибку.

### Запуск как Cron задача

Вы можете автоматизировать процесс бэкапа, создав задачу Cron. Например, чтобы запускать бэкап каждый день в 2:00,
добавьте следующую строку в ваш файл crontab:

```bash
0 2 * * * /path/to/reback backup >> /path/to/logs/backup.log 2>&1
```

Эта задача Cron будет:

- Выполнять команду `./reback backup` каждый день в 2:00.
- Перенаправлять как стандартный вывод, так и вывод ошибок в лог-файл (`backup.log`).

Для редактирования crontab используйте команду:

```bash
crontab -e
```

Затем добавьте строку задачи Cron. Убедитесь, что путь к бинарнику `reback` и лог-файлу указан правильно.

## Автор

Автор программы: Иван Ашихмин  
Telegram для связи: [https://t.me/proDreams](https://t.me/proDreams)

Программа выполнена в рамках проекта "Код на салфетке".

- Сайт: [https://pressanybutton.ru/](https://pressanybutton.ru/)
- Telegram-канал: [https://t.me/press_any_button](https://t.me/press_any_button)

## Поддержка

Если вам нравится этот проект и вы хотите поддержать его дальнейшее развитие, рассмотрите возможность доната:

- Донат через TON: `UQBU8rJEfUcBvJUbz6NbXiWxaOO_NoXHK_pXOWv7qsOBWbFp`
- [Поддержка на Boosty](https://boosty.to/prodream)
- [В нашем Telegram-боте за Telegram Stars](https://t.me/press_any_button_bot?start=donate)

Ваша поддержка помогает проекту развиваться и улучшать будущие функции!

## Лицензия

Этот проект распространяется под лицензией MIT. Подробности можно найти в файле [LICENSE](LICENSE).
